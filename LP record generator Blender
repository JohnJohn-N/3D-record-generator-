#----------------------------------------------------------------------------
#Project Name: [Blender 3D record generator]
#Copyright (c) 2026 [JohnJohn Nevado]
#This work is licensed under the Creative Commons Attribution-NonCommercial 
#4.0 International License. To view a copy of this license, visit 
#http://creativecommons.org/licenses/by-nc/4.0/
#PROHIBITED: Commercial use, resale, or distribution for profit.
#----------------------------------------------------------------------------

import bpy
import bmesh
import math
import wave
import struct
import os

# ================= CONFIGURATION =================
# REMEMBER: Use double slashes for Windows paths (e.g., "C:\\Music\\file.wav")
FILE_PATH = "/Users/YourName/Desktop/song.wav"  # <-- DOUBLE CHECK THIS PATH"  
DIAMETER = 230.0        
HOLE_RADIUS = 3.65      
THICKNESS = 2.0         

# GEOMETRY SETTINGS
PITCH = 2.0             # Distance between turns
GROOVE_WIDTH = 0.8      # The width of the actual "V" cut (Keep this tight for tracking)
GROOVE_DEPTH = 0.5      # Depth of the "V"
AMPLITUDE_SCALE = 0.6   # Audio Volume

# "WINGS" (The Gap Fillers)
# We make the strip wider than the Pitch to force an overlap.
# This ensures the "Land" between grooves is solid.
STRIP_WIDTH = PITCH * 1.1 

RPM = 33.33
AUDIO_DURATION = 30.0   
ANGULAR_RES = 4500      
# =================================================

def create_solid_v_record():
    # 1. CLEANUP
    if "Solid_Record" in bpy.data.objects:
        bpy.data.objects.remove(bpy.data.objects["Solid_Record"], do_unlink=True)

    # 2. LOAD AUDIO (With Safety Check)
    audio_raw = []
    if os.path.exists(FILE_PATH):
        try:
            with wave.open(FILE_PATH, 'rb') as w:
                frames = w.readframes(int(w.getframerate() * AUDIO_DURATION))
                samples = struct.unpack(f"<{len(frames)//2}h", frames)
                audio_raw = [s / 32768.0 for s in samples[::2]]
            print("Audio Loaded Successfully.")
        except:
            print("Audio Load Error. Using Test Tone.")
            audio_raw = [math.sin(x/10) for x in range(int(AUDIO_DURATION*1000))]
    else:
        print("File Not Found. Using Test Tone.")
        audio_raw = [math.sin(x/10) for x in range(int(AUDIO_DURATION*1000))]

    mesh = bpy.data.meshes.new("Solid_Record")
    obj = bpy.data.objects.new("Solid_Record", mesh)
    bpy.context.collection.objects.link(obj)
    bm = bmesh.new()

    print("Generating Solid Geometry... (This creates 'Wings' to fill gaps)")

    # 3. CALCULATE PATH
    total_revolutions = (AUDIO_DURATION / 60.0) * RPM
    outer_r = (DIAMETER / 2) - 2.0
    total_steps = int(total_revolutions * ANGULAR_RES)
    
    prev_verts = None
    
    # We define the ribbon profile with 5 points to separate the "Groove" from the "Land"
    # [Wing_Left] -- [Groove_Lip_L] -- [Valley_Bottom] -- [Groove_Lip_R] -- [Wing_Right]
    
    wing_offset = STRIP_WIDTH / 2
    lip_offset = GROOVE_WIDTH / 2

    for i in range(total_steps + 1):
        t = i / total_steps
        angle = t * total_revolutions * 2 * math.pi
        
        # Spiral Base Center
        base_r = outer_r - (t * total_revolutions * PITCH)
        if base_r < (HOLE_RADIUS + 5.0): break

        # Audio Displacement (Only applies to the Groove, not the Base Spiral)
        # Actually, let's wiggle the whole center path so the groove wiggles
        sample_idx = int(t * (len(audio_raw) - 1))
        audio_val = audio_raw[sample_idx] * AMPLITUDE_SCALE if sample_idx < len(audio_raw) else 0
        
        # Center of the groove (Wiggles with audio)
        r_center = base_r + audio_val
        
        # Coordinates
        cos_a = math.cos(angle)
        sin_a = math.sin(angle)
        
        # 1. Wing Left (Outer Edge of this strip) - Fixed to Base Spiral (No Wiggle) to ensure overlap
        # NOTE: To ensure gaps are filled, wings follow the smooth spiral, Groove follows Audio.
        r_wing_l = base_r + wing_offset
        
        # 2. Lip Left (Start of V) - Follows Audio
        r_lip_l = r_center + lip_offset
        
        # 3. Valley (Bottom of V) - Follows Audio
        r_valley = r_center
        
        # 4. Lip Right (End of V) - Follows Audio
        r_lip_r = r_center - lip_offset
        
        # 5. Wing Right (Inner Edge) - Fixed to Base Spiral
        r_wing_r = base_r - wing_offset

        # CREATE VERTICES (Z=0 for top surface, Z=-Depth for groove)
        v1 = bm.verts.new((r_wing_l * cos_a, r_wing_l * sin_a, 0))
        v2 = bm.verts.new((r_lip_l * cos_a, r_lip_l * sin_a, 0))
        v3 = bm.verts.new((r_valley * cos_a, r_valley * sin_a, -GROOVE_DEPTH))
        v4 = bm.verts.new((r_lip_r * cos_a, r_lip_r * sin_a, 0))
        v5 = bm.verts.new((r_wing_r * cos_a, r_wing_r * sin_a, 0))
        
        current_verts = [v1, v2, v3, v4, v5]
        
        # STITCH FACES
        if prev_verts:
            # We stitch the 4 segments of the strip
            for k in range(4):
                bm.faces.new((prev_verts[k], current_verts[k], current_verts[k+1], prev_verts[k+1]))
            
        prev_verts = current_verts

    # 4. EXTRUDE DOWN (Make it a Solid Block)
    print("Extruding Base...")
    bmesh.ops.recalc_face_normals(bm, faces=bm.faces)
    
    # Select all faces we just made
    faces = list(bm.faces)
    
    # Extrude
    res = bmesh.ops.extrude_face_region(bm, geom=faces)
    extruded_verts = [v for v in res['geom'] if isinstance(v, bmesh.types.BMVert)]
    
    # Flatten Bottom
    for v in extruded_verts:
        v.co.z = -THICKNESS
        
    # 5. CLEANUP
    # This might take a moment because of the overlapping geometry
    # We will skip 'remove doubles' on the whole mesh to avoid merging the V-groove shut
    # The Slicer will handle the overlapping volumes better than Blender boolean.
    
    bm.to_mesh(mesh)
    bm.free()
    
    # 6. FILL CENTER & CUT HOLE
    bpy.context.view_layer.objects.active = obj
    
    # Fill Center (Cylinder)
    bpy.ops.mesh.primitive_cylinder_add(radius=base_r + 2, depth=THICKNESS, location=(0,0,-THICKNESS/2))
    center = bpy.context.object
    obj.select_set(True)
    center.select_set(True)
    bpy.ops.object.join() # Simple Join (Slicer will merge)
    
    # Cut Spindle Hole
    bpy.ops.mesh.primitive_cylinder_add(radius=HOLE_RADIUS, depth=THICKNESS*5, location=(0,0,-THICKNESS))
    cutter = bpy.context.object
    mod = obj.modifiers.new(name="Hole", type='BOOLEAN')
    mod.object = cutter
    bpy.ops.object.modifier_apply(modifier="Hole")
    bpy.data.objects.remove(cutter)
    
    print("DONE: Solid Record with Overlapping Wings Created.")

create_solid_v_record()
